apiVersion: networking.istio.io/v1alpha3
kind: EnvoyFilter
metadata:
  name: {{ .Release.Name }}-hybrid-ratelimit
  namespace: {{ .Values.rateLimit.istioNamespace }}
spec:
  workloadSelector:
    labels:
      istio: {{ .Values.rateLimit.ingressGatewayLabel }}
  configPatches:
    - applyTo: HTTP_FILTER
      match:
        context: GATEWAY
        listener:
          filterChain:
            filter:
              name: "envoy.filters.network.http_connection_manager"
              subFilter:
                name: "envoy.filters.http.router"
      patch:
        operation: INSERT_BEFORE
        value:
          name: envoy.filters.http.lua.tagger
          typed_config:
            "@type": "type.googleapis.com/envoy.extensions.filters.http.lua.v3.Lua"
            inlineCode: |
              function envoy_on_request(request_handle)
                local headers = request_handle:headers()
                local cookie = headers:get("cookie")
                local user_id = nil
                
                if cookie then
                  local s, e = string.find(cookie, "user_id=[^;]+")
                  if s then
                    user_id = string.sub(cookie, s+8, e)
                  end
                end

                if not user_id then
                  user_id = "u-" .. os.time() .. "-" .. math.random(10000, 99999)
                  request_handle:streamInfo():dynamicMetadata():set("envoy.filters.http.lua.tagger", "set_cookie", "true")
                end
                
                headers:add("x-user-id", user_id)
                
                request_handle:streamInfo():dynamicMetadata():set("envoy.filters.http.lua.tagger", "user_id", user_id)
              end

              function envoy_on_response(response_handle)
                local meta = response_handle:streamInfo():dynamicMetadata():get("envoy.filters.http.lua.tagger")
                if meta then
                   local uid = meta["user_id"]
                   -- Only set the cookie if we generated a new ID
                   if meta["set_cookie"] == "true" then
                      response_handle:headers():add("Set-Cookie", "user_id=" .. uid .. "; Path=/; Max-Age=86400")
                   end
                end
              end
    - applyTo: HTTP_FILTER
      match:
        context: GATEWAY
        listener:
          filterChain:
            filter:
              name: "envoy.filters.network.http_connection_manager"
              subFilter:
                name: "envoy.filters.http.router"
      patch:
        operation: INSERT_BEFORE
        value:
          name: envoy.filters.http.local_ratelimit
          typed_config:
            "@type": type.googleapis.com/envoy.extensions.filters.http.local_ratelimit.v3.LocalRateLimit
            stat_prefix: http_local_rate_limiter
            token_bucket:
              max_tokens: {{ .Values.rateLimit.requestsPerMinute }}
              tokens_per_fill: {{ .Values.rateLimit.requestsPerMinute }}
              fill_interval: 60s
            filter_enabled:
              runtime_key: local_rate_limit_enabled
              default_value:
                numerator: 100
                denominator: HUNDRED
            filter_enforced:
              runtime_key: local_rate_limit_enforced
              default_value:
                numerator: 100
                denominator: HUNDRED
            descriptors:
            - entries:
              - key: client_id
            stage: 0

    - applyTo: HTTP_ROUTE
      match:
        context: GATEWAY
        routeConfiguration:
          vhost:
            route:
              action: ANY
      patch:
        operation: MERGE
        value:
          route:
            rate_limits:
            - actions:
              - request_headers:
                  header_name: "x-user-id"
                  descriptor_key: "client_id"